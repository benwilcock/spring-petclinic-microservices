apiVersion: "v1"
kind: "Service"
metadata:
  name: "tracing-server"
spec:
  ports:
    - port: 9411
      targetPort: 9411
  selector:
    app: "tracing"
  type: "NodePort"
---
apiVersion: "v1"
kind: "Service"
metadata:
  name: "config-server"
spec:
  ports:
    - port: 8888
      targetPort: 8888
  selector:
    app: "config"
  type: "NodePort"
---
apiVersion: "v1"
kind: "Service"
metadata:
  name: "admin-server"
spec:
  ports:
    - port: 9090
      targetPort: 9090
  selector:
    app: "admin"
  type: "NodePort"
---
apiVersion: "v1"
kind: "Service"
metadata:
  name: "vets-service"
spec:
  ports:
    - port: 8083
      targetPort: 8083
  selector:
    app: "vets"
  type: "NodePort"
---
apiVersion: "v1"
kind: "Service"
metadata:
  name: "visits-service"
spec:
  ports:
    - port: 8082
      targetPort: 8082
  selector:
    app: "visits"
  type: "NodePort"
---
apiVersion: "v1"
kind: "Service"
metadata:
  name: "customers-service"
spec:
  ports:
    - port: 8081
      targetPort: 8081
  selector:
    app: "customers"
  type: "NodePort"
---
apiVersion: "v1"
kind: "Service"
metadata:
  name: "api-gateway"
spec:
  ports:
    - port: 8080
      targetPort: 8080
  selector:
    app: "gateway"
  type: "NodePort"
---
apiVersion: "apps/v1"
kind: "Deployment"
metadata:
  name: "tracing-deployment"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "tracing"
  template:
    metadata:
      labels:
        app: "tracing"
    spec:
      containers:
        - image: "openzipkin/zipkin-slim:2"
          imagePullPolicy: "Always"
          livenessProbe:
            failureThreshold: 4
            httpGet:
              path: "/actuator/health"
              port: 9411
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 15
          name: "tracing"
          ports:
            - containerPort: 9411
---
apiVersion: "apps/v1"
kind: "Deployment"
metadata:
  name: "config-deployment"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "config"
  template:
    metadata:
      labels:
        app: "config"
    spec:
      containers:
        - env:
            - name: "SPRING_PROFILES_ACTIVE"
              value: "kubernetes"
            - name: "PORT"
              value: "8888"
            - name: "GIT_CONFIG_URI"
              value: "https://github.com/benwilcock/spring-petclinic-microservices-config"
            - name: "CONFIG_SERVER_URI"
              value: "http://config-server.default.svc.cluster.local:8888"
            - name: "TRACING_SERVER_URI"
              value: "http://tracing-server.default.svc.cluster.local:9411"
          image: "benwilcock/spring-petclinic-config-server:2.4.3"
          imagePullPolicy: "Always"
          livenessProbe:
            failureThreshold: 4
            httpGet:
              path: "/actuator/health"
              port: 8888
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 15
          name: "config"
          ports:
            - containerPort: 8888
---
apiVersion: "apps/v1"
kind: "Deployment"
metadata:
  name: "admin-deployment"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "admin"
  template:
    metadata:
      labels:
        app: "admin"
    spec:
      containers:
        - env:
            - name: "SPRING_PROFILES_ACTIVE"
              value: "kubernetes"
            - name: "PORT"
              value: "9090"
            - name: "GIT_CONFIG_URI"
              value: "https://github.com/benwilcock/spring-petclinic-microservices-config"
            - name: "CONFIG_SERVER_URI"
              value: "http://config-server.default.svc.cluster.local:8888"
            - name: "TRACING_SERVER_URI"
              value: "http://tracing-server.default.svc.cluster.local:9411"
          image: "benwilcock/spring-petclinic-admin-server-k8s:2.4.3"
          imagePullPolicy: "Always"
          livenessProbe:
            failureThreshold: 4
            httpGet:
              path: "/actuator/health"
              port: 9090
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 15
          name: "admin"
          ports:
            - containerPort: 9090
---
apiVersion: "apps/v1"
kind: "Deployment"
metadata:
  name: "vets-deployment"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "vets"
  template:
    metadata:
      labels:
        app: "vets"
    spec:
      containers:
        - env:
            - name: "SPRING_PROFILES_ACTIVE"
              value: "kubernetes"
            - name: "PORT"
              value: "8083"
            - name: "GIT_CONFIG_URI"
              value: "https://github.com/benwilcock/spring-petclinic-microservices-config"
            - name: "CONFIG_SERVER_URI"
              value: "http://config-server.default.svc.cluster.local:8888"
            - name: "TRACING_SERVER_URI"
              value: "http://tracing-server.default.svc.cluster.local:9411"
          image: "benwilcock/spring-petclinic-vets-service:2.4.3"
          imagePullPolicy: "Always"
          livenessProbe:
            failureThreshold: 4
            httpGet:
              path: "/actuator/health"
              port: 8083
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 15
          name: "vets"
          ports:
            - containerPort: 8083
---
apiVersion: "apps/v1"
kind: "Deployment"
metadata:
  name: "visits-deployment"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "visits"
  template:
    metadata:
      labels:
        app: "visits"
    spec:
      containers:
        - env:
            - name: "SPRING_PROFILES_ACTIVE"
              value: "kubernetes"
            - name: "PORT"
              value: "8082"
            - name: "GIT_CONFIG_URI"
              value: "https://github.com/benwilcock/spring-petclinic-microservices-config"
            - name: "CONFIG_SERVER_URI"
              value: "http://config-server.default.svc.cluster.local:8888"
            - name: "TRACING_SERVER_URI"
              value: "http://tracing-server.default.svc.cluster.local:9411"
          image: "benwilcock/spring-petclinic-visits-service:2.4.3"
          imagePullPolicy: "Always"
          livenessProbe:
            failureThreshold: 4
            httpGet:
              path: "/actuator/health"
              port: 8082
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 15
          name: "visits"
          ports:
            - containerPort: 8082
---
apiVersion: "apps/v1"
kind: "Deployment"
metadata:
  name: "customers-deployment"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "customers"
  template:
    metadata:
      labels:
        app: "customers"
    spec:
      containers:
        - env:
            - name: "SPRING_PROFILES_ACTIVE"
              value: "kubernetes"
            - name: "PORT"
              value: "8081"
            - name: "GIT_CONFIG_URI"
              value: "https://github.com/benwilcock/spring-petclinic-microservices-config"
            - name: "CONFIG_SERVER_URI"
              value: "http://config-server.default.svc.cluster.local:8888"
            - name: "TRACING_SERVER_URI"
              value: "http://tracing-server.default.svc.cluster.local:9411"
          image: "benwilcock/spring-petclinic-customers-service:2.4.3"
          imagePullPolicy: "Always"
          livenessProbe:
            failureThreshold: 4
            httpGet:
              path: "/actuator/health"
              port: 8081
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 15
          name: "customers"
          ports:
            - containerPort: 8081
---
apiVersion: "apps/v1"
kind: "Deployment"
metadata:
  name: "gateway-deployment"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "gateway"
  template:
    metadata:
      labels:
        app: "gateway"
    spec:
      containers:
        - env:
            - name: "SPRING_PROFILES_ACTIVE"
              value: "kubernetes"
            - name: "PORT"
              value: "8080"
            - name: "GIT_CONFIG_URI"
              value: "https://github.com/benwilcock/spring-petclinic-microservices-config"
            - name: "CONFIG_SERVER_URI"
              value: "http://config-server.default.svc.cluster.local:8888"
            - name: "TRACING_SERVER_URI"
              value: "http://tracing-server.default.svc.cluster.local:9411"
          image: "benwilcock/spring-petclinic-api-gateway:2.4.3"
          imagePullPolicy: "Always"
          livenessProbe:
            failureThreshold: 4
            httpGet:
              path: "/actuator/health"
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 15
          name: "gateway"
          ports:
            - containerPort: 8080
